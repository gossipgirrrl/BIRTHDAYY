<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday!</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary-blue: #00a8ff;
            --deep-bg: #050a14;
            --text-color: #e0e0e0;
            --cake-color: #1a1a1a;
            --icing-color: #00a8ff;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Poppins', sans-serif;
            background-color: var(--deep-bg);
            background-image: radial-gradient(circle at center, #0c1a36 0%, #000000 100%);
            color: var(--text-color);
            overflow: hidden; 
            text-align: center;
        }

        /* --- STARS --- */
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0; animation: twinkle 2s infinite ease-in-out; z-index: 0; }
        @keyframes twinkle { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 0.8; transform: scale(1.2); } 100% { opacity: 0; transform: scale(0.5); } }

        /* --- BALLOONS --- */
        .balloon { position: absolute; bottom: -100px; width: 40px; height: 50px; background: var(--primary-blue); border-radius: 50%; opacity: 0.6; z-index: 1; animation: floatUp 10s linear infinite; }
        .balloon::before { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 2px; height: 40px; background: rgba(255,255,255,0.3); }
        @keyframes floatUp { 0% { bottom: -100px; transform: translateX(0); } 50% { transform: translateX(20px); } 100% { bottom: 110vh; transform: translateX(-20px); } }

        /* --- START SCREEN --- */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999; cursor: pointer; }
        #start-screen h2 { font-family: 'Dancing Script', cursive; font-size: 3em; color: var(--primary-blue); animation: pulse 1.5s infinite; text-transform: uppercase; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        #cake-section { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 1s ease-in-out; z-index: 10; position: relative; }

        /* --- CAKE --- */
        .cake { position: relative; width: 250px; height: 200px; margin-bottom: 50px; margin-top: 50px; }
        .plate { width: 270px; height: 10px; background-color: #ccc; border-radius: 10px; position: absolute; bottom: 0; left: -10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .layer { position: absolute; background-color: var(--cake-color); width: 100%; border-radius: 5px 5px 0 0; box-shadow: inset -10px 0px 10px rgba(0,0,0,0.5); }
        .layer-bottom { height: 80px; bottom: 10px; width: 250px; }
        .layer-middle { height: 60px; bottom: 90px; width: 200px; left: 25px; }
        .icing { position: absolute; background-color: var(--icing-color); width: 100%; height: 15px; top: 0; border-radius: 5px 5px 0 0; z-index: 1; }
        .drip { position: absolute; background-color: var(--icing-color); width: 15px; height: 30px; border-radius: 0 0 10px 10px; top: 10px; }
        .drip:nth-child(1) { left: 10%; height: 25px; } .drip:nth-child(2) { left: 30%; height: 35px; } .drip:nth-child(3) { left: 50%; height: 20px; } .drip:nth-child(4) { left: 70%; height: 30px; } .drip:nth-child(5) { left: 90%; height: 15px; }
        .candle-container { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 5; }
        .candle { width: 10px; height: 35px; background: #fff; border: 1px solid #ddd; border-radius: 3px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .flame { width: 12px; height: 20px; background: radial-gradient(ellipse at bottom, #ffff00 0%, #ffad33 60%, #ff3300 100%); border-radius: 50% 50% 20% 20%; position: absolute; top: -20px; left: -1px; animation: flicker 0.1s infinite alternate; transform-origin: center bottom; }
        @keyframes flicker { 0% { transform: scale(1) rotate(-2deg); opacity: 0.9; } 100% { transform: scale(1) rotate(2deg); opacity: 1; } }
        .flame.out { display: none; }
        
        #instruction-text { font-size: 1.4em; color: var(--primary-blue); margin-top: 20px; text-shadow: 0 0 10px rgba(0, 168, 255, 0.5); }

        /* --- LETTER SECTION --- */
        #letter-section {
            display: none;
            height: auto; 
            min-height: 100vh;
            padding: 50px 20px;
            background: rgba(0,0,0,0.7);
            opacity: 0;
            transition: opacity 2s ease-in;
            z-index: 20;
            position: relative;
        }
        .content-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(12, 26, 54, 0.9);
            padding: 40px;
            border-radius: 20px;
            border: 2px solid var(--primary-blue);
            box-shadow: 0 0 30px rgba(0, 168, 255, 0.4);
            backdrop-filter: blur(10px);
            word-wrap: break-word;
        }
        .his-photo {
            width: 200px;
            height: 200px;
            /* Corrected File Name from your upload */
            background-image: url('IMG_20260122_233447_756.jpg');
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            border: 4px solid var(--primary-blue);
            margin: 0 auto 30px auto;
            box-shadow: 0 0 15px var(--primary-blue);
            animation: floatPhoto 4s ease-in-out infinite;
        }
        @keyframes floatPhoto { 0% {transform: translateY(0px);} 50% {transform: translateY(-10px);} 100% {transform: translateY(0px);} }
        h1.birthday-header { font-family: 'Dancing Script', cursive; font-size: 3.5em; color: var(--primary-blue); margin-bottom: 10px;}
        .letter-text { font-size: 1.1em; line-height: 1.8; text-align: left; white-space: pre-wrap; min-height: 100px; }
        .cursor { display: inline-block; width: 2px; height: 1em; background-color: var(--primary-blue); animation: blink 1s infinite; }
        @keyframes blink { 0% {opacity:1;} 50% {opacity:0;} 100% {opacity:1;} }

    </style>
</head>
<body>

    <div id="stars-container"></div>
    <div id="balloons-container"></div>

    <div id="start-screen">
        <h2>Hey Birthday Boy</h2>
        <p>Tap anywhere to start...</p>
        <p style="font-size:0.8em; opacity: 0.7;">(Allow Microphone Access!)</p>
    </div>

    <div id="cake-section">
        <div class="cake">
            <div class="plate"></div>
            <div class="layer layer-bottom"></div>
            <div class="layer layer-middle">
                <div class="icing">
                    <div class="drip"></div><div class="drip"></div><div class="drip"></div><div class="drip"></div><div class="drip"></div>
                </div>
            </div>
            <div class="candle-container">
                <div class="candle"><div class="flame"></div></div>
                <div class="candle"><div class="flame"></div></div>
                <div class="candle"><div class="flame"></div></div>
            </div>
        </div>
        <div id="instruction-text">Blow hard into the mic!</div>
    </div>

    <div id="letter-section">
        <div class="content-container">
            <div class="his-photo"></div>
            <h1 class="birthday-header">Happy Birthday habiby!</h1>
            <div class="letter-text" id="typewriter-text"></div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Using backticks (`) to safely handle your quotes
        const finalLetter ='Omryyyy yuyuu,

Happy Birthday to the man who carries my heart in his hands. I’m trying to find the right words to tell you what you mean to me, but sometimes I love you just doesn't feel big enough. That’s why I’m so glad we have our own word.

To the world, you are younes, but to me, you are my habiby, my hayati, and my eyounii li nmout elih. You're the very breath I take. You have a way of making everything feel calm and beautiful just by being near me and hearing your voice.

I want you to know how much I truly treasure you. Nhabek bzef ❤️!! more than I could ever explain in a single letter. You are my best friend, my protector, khoya, sahbi, my papii and my soulmate. My love for you is so deep that I would truly give anything to see you happy by my side forever.

Thank you for being the person you are, for your kindness, your strength, and the way you love me. I hope today is filled with all the joy you bring into my life every single day. I promise to spend the rest of our birthdays making sure you feel like the luckiest man alive.

No matter where we go or what we do, it will always be you.
Amevia, now and forever. MUAAAH ❤️

With all my love,
Niny';

        const startScreen = document.getElementById('start-screen');
        const cakeSection = document.getElementById('cake-section');
        const letterSection = document.getElementById('letter-section');
        const flames = document.querySelectorAll('.flame');
        const instructionText = document.getElementById('instruction-text');
        const typewriterElement = document.getElementById('typewriter-text');

        let audioContext, analyser, microphone;
        let isListening = false;
        let candlesBlown = false;
        let blowStreak = 0; 

        function createStars() {
            const container = document.getElementById('stars-container');
            for(let i=0; i<50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }
        createStars();

        function releaseBalloons() {
            const container = document.getElementById('balloons-container');
            const colors = ['#00a8ff', '#1a1a1a', '#005785'];
            for(let i=0; i<15; i++) {
                const balloon = document.createElement('div');
                balloon.className = 'balloon';
                balloon.style.left = Math.random() * 100 + 'vw';
                balloon.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                balloon.style.animationDuration = (Math.random() * 5 + 5) + 's';
                balloon.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(balloon);
            }
        }

        // --- FIXED START LOGIC ---
        startScreen.addEventListener('click', async () => {
            // 1. Instantly hide the start screen so it doesn't feel frozen
            startScreen.style.opacity = '0';
            setTimeout(() => { 
                startScreen.style.display = 'none';
                cakeSection.style.opacity = '1';
                cakeSection.style.pointerEvents = 'all';
                
                // 2. NOW we ask for the mic (after the screen has changed)
                navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    initializeAudio(stream);
                })
                .catch(err => {
                    console.error("Mic denied:", err);
                    alert("I need to hear you to blow the candles! Please refresh and allow Microphone access.");
                });

            }, 800);
        });

        function initializeAudio(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            isListening = true;
            detectBlow();
        }

        function detectBlow() {
            if (!isListening || candlesBlown) return;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            let lowFreqCount = Math.floor(bufferLength / 2);
            for(let i = 0; i < lowFreqCount; i++) { sum += dataArray[i]; }
            let average = sum / lowFreqCount;

            // Sensitivity threshold
            if (average > 140) { blowStreak++; } else { blowStreak = 0; }

            if (blowStreak > 5) {
                celebrate();
            } else {
                requestAnimationFrame(detectBlow);
            }
        }

        function celebrate() {
            candlesBlown = true;
            isListening = false;
            
            flames.forEach(f => f.classList.add('out'));
            instructionText.innerText = "YAY! Happy Birthday!";
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00a8ff', '#ffffff', '#000000'] });

            setTimeout(() => {
                cakeSection.style.opacity = '0';
                setTimeout(() => {
                    cakeSection.style.display = 'none';
                    letterSection.style.display = 'block';
                    document.body.style.overflow = 'auto'; // Enable scrolling for the letter
                    releaseBalloons();
                    
                    setTimeout(() => {
                        letterSection.style.opacity = '1';
                        typeWriter(); 
                    }, 100);
                }, 1000);
            }, 2500);
        }

        let charIndex = 0;
        function typeWriter() {
            if (charIndex < finalLetter.length) {
                const char = finalLetter.charAt(charIndex);
                if(char === '\n') {
                    typewriterElement.innerHTML += '<br>';
                } else {
                    typewriterElement.innerHTML += char;
                }
                charIndex++;
                setTimeout(typeWriter, 50); 
            } else {
                typewriterElement.innerHTML += "<span class='cursor'></span>";
            }
        }
    </script>
</body>
</html>

        const startScreen = document.getElementById('start-screen');
        const cakeSection = document.getElementById('cake-section');
        const letterSection = document.getElementById('letter-section');
        const flames = document.querySelectorAll('.flame');
        const instructionText = document.getElementById('instruction-text');
        const bgMusic = document.getElementById('bg-music');
        const cheerSound = document.getElementById('cheer-sound');
        const typewriterElement = document.getElementById('typewriter-text');
        
        bgMusic.volume = 0.5;
        cheerSound.volume = 0.6;

        let audioContext, analyser, microphone;
        let isListening = false;
        let candlesBlown = false;
        let blowStreak = 0; 

        function createStars() {
            const container = document.getElementById('stars-container');
            for(let i=0; i<50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + 'vw';
                star.style.top = Math.random() * 100 + 'vh';
                star.style.width = Math.random() * 3 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }
        createStars();

        function releaseBalloons() {
            const container = document.getElementById('balloons-container');
            const colors = ['#00a8ff', '#1a1a1a', '#005785'];
            for(let i=0; i<15; i++) {
                const balloon = document.createElement('div');
                balloon.className = 'balloon';
                balloon.style.left = Math.random() * 100 + 'vw';
                balloon.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                balloon.style.animationDuration = (Math.random() * 5 + 5) + 's';
                balloon.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(balloon);
            }
        }

        startScreen.addEventListener('click', async () => {
            try {
                bgMusic.play();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                startScreen.style.opacity = '0';
                setTimeout(() => { 
                    startScreen.style.display = 'none';
                    cakeSection.style.opacity = '1';
                    cakeSection.style.pointerEvents = 'all';
                    initializeAudio(stream);
                }, 1000);
            } catch (err) {
                alert("Please allow microphone access for the magic to work!");
            }
        });

        function initializeAudio(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 512;
            isListening = true;
            detectBlow();
        }

        function detectBlow() {
            if (!isListening || candlesBlown) return;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            let lowFreqCount = Math.floor(bufferLength / 2);
            for(let i = 0; i < lowFreqCount; i++) { sum += dataArray[i]; }
            let average = sum / lowFreqCount;

            if (average > 140) { blowStreak++; } else { blowStreak = 0; }

            if (blowStreak > 5) {
                celebrate();
            } else {
                requestAnimationFrame(detectBlow);
            }
        }

        function celebrate() {
            candlesBlown = true;
            isListening = false;
            
            flames.forEach(f => f.classList.add('out'));
            instructionText.innerText = "YAY! Happy Birthday!";
            
            cheerSound.play();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#00a8ff', '#ffffff', '#000000'] });

            setTimeout(() => {
                cakeSection.style.opacity = '0';
                setTimeout(() => {
                    cakeSection.style.display = 'none';
                    letterSection.style.display = 'block';
                    
                    // --- FIX FOR SCROLLING ---
                    document.body.style.overflow = 'auto'; // UNLOCKS SCROLLING HERE!
                    
                    releaseBalloons();
                    
                    setTimeout(() => {
                        letterSection.style.opacity = '1';
                        typeWriter(); 
                    }, 100);
                }, 1000);
            }, 3000);
        }

        let charIndex = 0;
        function typeWriter() {
            if (charIndex < finalLetter.length) {
                const char = finalLetter.charAt(charIndex);
                if(char === '\n') {
                    typewriterElement.innerHTML += '<br>';
                } else {
                    typewriterElement.innerHTML += char;
                }
                charIndex++;
                setTimeout(typeWriter, 50); 
            } else {
                typewriterElement.innerHTML += "<span class='cursor'></span>";
            }
        }
    </script>
</body>
</html>